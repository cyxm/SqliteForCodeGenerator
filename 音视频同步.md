# 音视频同步

## 整体流程

音视频同步有以下三种方式
- 与视频时间同步
- 与音频时间同步
- 与系统时间同步

由于人对音频的感受更为敏感,需保证音频播放的稳定,连续.另外考虑到实时流中音频帧丢失的情况,因此采用音频时间同步和系统时间同步的混合方式.

## 各个阶段可能遇到的问题

### 获取音视频流

音视频流在获取阶段,可能遇到以下几个问题.

- 音视频源传输过慢,无法及时获取(等待)
- 音视频源传输过快,无法及时处理(阻塞)
- 音视频源丢失(丢帧)

#### 1. 网络直播流

网络直播流的特点是流时间必定小于当前时间,当前市场上终端的性能通常不会产生阻塞.根据网络情况会有一定的丢帧率,且不适合使用重传机制.  

- 当 (解码时间+渲染时间)(ms) < (1000/FPS) 时,主要处理等待状态.

- 当 (解码时间+渲染时间)(ms) >= (1000/FPS) 时,主要处理阻塞状态.考虑当前市场上终端的性能,此状态作为次要情况考虑.

#### 2. 网络录播流

网络录播流的特点是,根据网络情况的不同,流既可能处于等待状态,也可能处于阻塞状态.终端可以做一定的缓存来保证视频流畅播放.  

录播流可以实现倍速播放,常用倍率有:  
- 缓速:0.5 0.75 可以用于捕捉部分高速场景  
- 常速:1.0  
- 加速:1.25 1.5 2.0 可以用于快速浏览,但要求网络情况良好,并且有足够的渲染速率  

#### 3. 文件流

文件流的特点是流获取的速率通常大于解码渲染的速率.此时文件读取模块要根据后续解码渲染模块的回调调整读取速率.

### 音视频流解码

解码有以下几种方式

>- 同步
>- 异步

>- 硬解
>- 软解

### 音视频流渲染

#### 1. 视频渲染

Android平台:
>- 直接渲染模式,通过将MediaCodec和Surface绑定进行直接渲染.  
优点:  
兼容性强  
缺点:  
无法对解码后的数据做任何处理
>- OpenGL ES模式
优点:  
可以自由处理解码后的数据,灵活性较大
缺点:  
需要处理解码后的数据格式,可能有兼容性的问题

### 同步需处理的问题

#### 1. 首帧处理

首帧需要处理以下几个问题:  
1. 第一个视频帧先于音频帧到来.